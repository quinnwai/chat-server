<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>

<body>
<div id = "main">
    <div id="availableRooms">
        <h2> Rooms </h2>
            <div id="add_room">
                <h3>Add Room</h3>
                Room name: <input type="text" id="add_room_name" /> <br>
                Password (optional): <input type="password" id="add_room_password" />
                <button id="add">add</button>
            </div>
        <button class="roomButton"> hi man </button>
    </div>
    <div id="messageArea">
        <h2> Send Messages </h2>
        Message: <input type="text" id="message_input" />
        To (optional, private message): <input type="text" id="username_input" />
        <button id="send">send</button>
        <div id="chatlog"></div>
    </div>
</div>
<script type="text/javascript">
    let user = prompt("Username:");
    while(user == ""){
        user = prompt("Username:");
    }
    
    let currentRoomId;
    let init = false;

    var socketio = io.connect();

    // get list and see what is returned
    socketio.emit("get_list_to_server", {});
    

    socketio.on("send_list_to_client", function (data) {
        if(!init) {
            showLobby(data);
            init = true;
        }
    });

    function showLobby(allRooms) {
        console.log(allRooms);
        for (let i = 0; i < allRooms.length; i++) {
            document.getElementById("availableRooms").innerHTML +=
                '<button id = "room_' + i + '"' + ' class = "roomButton">' + allRooms[i].room_name + '</button>';
        }
        for (let i = 0; i < allRooms.length; i++) {
            document.getElementById("room_" + i).addEventListener("click", function (event) {
                // console.log("I pressed :)");

                //send the name of guy who pressed button
                socketio.emit("send_button_presser_to_server", {author: user });
                socketio.on('send_button_presser_to_client', function (data) {
                    if (user == data["author"]) {
                        //check if this guy is the guy who pressed the button
                        if (allRooms[i].bannedUsers.includes(user)) {
                            alert("Sorry, you have been banned from this room");
                        }
                        else {
                            let pass = "";
                            let correct_pass = true;
                            if (allRooms[i].has_pass === true) {
                                correct_pass = false;
                                while (pass == ""){
                                pass = prompt("Please enter the room's password to gain access");
                                }
                                console.log({ password: pass, id: i });
                                socketio.emit("send_pass_to_server", { password: pass, id: i, author: user });
                                socketio.on('pass_validator_to_client', function (data) {
                                    correct_pass = data["isPass"];
                                    if (user == data["author"]) {
                                        if (correct_pass) {
                                            alert("Access granted");
                                            //do the thing where he is redirected to room
                                            currentRoomId = i;
                                            showRoom(currentRoomId);
                                        }
                                        else {
                                            alert("sorry, that was the wrong password");
                                        }
                                    }
                                });
                            }
                            else {
                                alert("Access granted");
                                currentRoomId = i;
                                showRoom(currentRoomId);
                                //do the thing where he is redirected to room
                            }

                        }
                    }
                })
            }, false);
        }
    }

    // shows the message stuff; shows user names
    function showRoom(roomId){
        socketio.emit("get_room_to_server", { room_id: roomId, author: user });
        
        // get active users and print them
        socketio.on("send_room_to_client", function (data) {
             // make sure this is the right user 
            if (user == data["receiver"]) {

                //get message div area
                let messageArea = document.getElementById("messageArea");

                // clear out everything in div
                // Source: https://www.javascripttutorial.net/dom/manipulating/remove-all-child-nodes/
                while(messageArea.firstChild){
                    messageArea.removeChild(messageArea.firstChild);
                }

                // let messageArea = removeMessages;

                //create header for messages
                header = document.createElement("h2");
                header.textContent = "Send Messages";
                messageArea.appendChild(header);

                // print out active user
                usersInRoom = data["active_users"];
                messageArea.appendChild(document.createTextNode("Active users: "));
                for(let i = 0; i < usersInRoom.length; i++){
                    messageArea.appendChild(document.createTextNode(usersInRoom[i]));

                    if(i != usersInRoom.length-1){
                        messageArea.appendChild(document.createTextNode(", "));
                    }
                }

                // add break
                messageArea.appendChild(document.createElement("br"));
        
                // create message and username (for dms) HTML inputs
                messageArea.appendChild(document.createTextNode("message:"));
                msg_input = document.createElement("input");
                msg_input.type = "text";
                msg_input.id = "message_input"
                messageArea.appendChild(msg_input);
        
                messageArea.appendChild(document.createTextNode(" to (optional, private message):"));
                usr_input = document.createElement("input");
                usr_input.type = "text";
                usr_input.id = "username_input"
                messageArea.appendChild(usr_input);
        
                // create button w/ send message listener
                let button = document.createElement("button");
                button.id = "send_message";
                button.textContent = "send";
                messageArea.appendChild(button);
        
                document.getElementById("send_message").addEventListener('click', sendMessage, false);
                
                // create chatlog div
                let chatlog = document.createElement("div");
                chatlog.id = "chatlog";
                document.body.appendChild(chatlog);

                // create leave button
                let leaveButton = document.createElement("button");
                leaveButton.id = "leave_room";
                leaveButton.textContent = "leave room";
                document.body.appendChild(leaveButton);

                //disable all buttons
                $("button.roomButton").attr("disabled", "disabled");

                // add event listener to leave button to clear out everything
                document.getElementById("leave_room").addEventListener("click", function (){
                    while(messageArea.firstChild){
                        messageArea.removeChild(messageArea.firstChild);
                    }

                    //TODO: make sure this works on leave button
                    // $("button.roomButton").attr("disabled", "enabled");
                });
            }
        });
    }


    // receives any messages sent from other clients (processed by the server)
    socketio.on("message_to_client", function (data) {
        /* 
        3 different cases:
           1. undefined receiver: global message 
           2. global user variable matches receiver: private message received
           3. global user matches author: private message that you sent out
        */
        if (data["receiver"] == undefined || data["receiver"] == user || data["author"] == user) {
            //Append an HR thematic break and the escaped HTML of the new message
            document.getElementById("chatlog").appendChild(document.createElement("hr"));

            //show author of message and content
            let msg = data['author'] + ": " + data['message'];
            document.getElementById("chatlog").appendChild(document.createTextNode(msg));
        }
    });

    function sendMessage() {
        var msg = document.getElementById("message_input").value;
        var usr = document.getElementById("username_input").value;

        // send private message info over if needed
        if (usr != "") {
            // socketio.emit("message_to_server", {message: msg, author: user, receiver: usr });
            socketio.emit("message_to_server", { message: msg, author: user, receiver: usr });
        }
        else {
            socketio.emit("message_to_server", { message: msg, author: user });
        }
    }

</script>
</body>
<!-- <script src="lobby.js"></script> -->
<!-- <script src = "chat_server.js"></script> -->
</html>