<!DOCTYPE html>
<html>
<head>
   <script src="/socket.io/socket.io.js"></script>
   <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>
<body>

   message: <input type="text" id="message_input"/>
   to (optional, private message): <input type="text" id="username_input"/>
   <button id="send">send</button>
   <div id="chatlog"></div>

   <script type ="text/javascript">
      let user = prompt("Username:");
      
      
      var socketio = io.connect();

      // get list and see what is returned
      socketio.emit("get_list_to_server", {});

      socketio.on("send_list_to_client", function(data){
         console.log(data);
         showLobby(data);
      });

      function showLobby(allRooms){
         for (let i = 0; i < allRooms.length; i++) {
            document.getElementById("availableRooms").innerHTML +=
               '<button id = "room_' + i + '"' + ' class = "roomButton">' + allRooms[i].roomName + '</button>';
         }
         for (let i = 0; i < allRooms.length; i++) {
            document.getElementById("room_" + i).addEventListener("click", function (event) {
               if (allRooms[i].bannedUsers.includes(user)) {
                  alert("Sorry, you have been banned from this room");
               }
               else {
                  let pass = "";
                  if (allRooms[i].roomPass !== "") {
                     pass = prompt("Please enter the room's password to gain access");
                  }
                  if (pass == allRooms[i].roomPass) {
                     alert("Access granted");
                     //do the thing where he is redirected to room
                  }
               }
            }, false);
         }
      }

      // receives any messages sent from other clients (processed by the server)
      socketio.on("message_to_client", function(data) {
         /* 
         3 different cases:
            1. undefined receiver: global message 
            2. global user variable matches receiver: private message received
            3. global user matches author: private message that you sent out
         */
         if(data["receiver"] == undefined || data["receiver"] == user || data["author"] == user){
            //Append an HR thematic break and the escaped HTML of the new message
            document.getElementById("chatlog").appendChild(document.createElement("hr"));
   
            //show author of message and content
            let msg = data['author']+": "+data['message'];
            document.getElementById("chatlog").appendChild(document.createTextNode(msg));
         }
      });
   
      function sendMessage(){
         var msg = document.getElementById("message_input").value;
         var usr = document.getElementById("username_input").value;
   
         // send private message info over if needed
         if(usr != ""){
            // socketio.emit("message_to_server", {message: msg, author: user, receiver: usr });
            socketio.emit("message_to_server", {message: msg, author: user, receiver: usr });
         }
         else{
            socketio.emit("message_to_server", {message: msg, author: user });
         }   
      }

      document.getElementById("send").addEventListener('click', sendMessage, false);
   </script>

</body>

</html>
